const config = require('../config')
const { cmd, commands } = require('../command')
const fs = require('fs');
const fileType = require("file-type");
const { getBuffer, getGroupAdmins, getRandom, h2k, isUrl, Json, runtime, sleep, fetchJson} = require('../lib/functions')
const path = require('path')
const { spawn } = require('child_process')
const ffmpegPath = require('@ffmpeg-installer/ffmpeg').path;
const ffmpeg = require('fluent-ffmpeg');
ffmpeg.setFfmpegPath(ffmpegPath);
const { Sticker, StickerTypes } = require('wa-sticker-formatter');

let imgmsg = config.LANG === 'SI' ? ' Ä·¥á·¥ò ü è ·¥õ·¥è ·¥Ä ·¥ò ú·¥è·¥õ·¥è!' : ' Ä·¥á·¥ò è ·¥õ·¥è ·¥Ä ·¥ò ú·¥è·¥õ·¥è “ì·¥è Ä s·¥õ…™·¥Ñ·¥ã·¥á Ä!';
let descg = config.LANG === 'SI' ? 'Sticker Converting...' : '…™·¥õ ·¥Ñ·¥è…¥·¥†·¥á Ä·¥õs  è·¥è·¥ú Ä  Ä·¥á·¥ò ü…™·¥á·¥Ö ·¥ò ú·¥è·¥õ·¥è ·¥õ·¥è s·¥õ…™·¥Ñ·¥ã·¥á Ä.';

function toAudio(buffer, ext) {
  return ffmpeg(buffer, [
    '-vn',
    '-ac', '2',
    '-b:a', '128k',
    '-ar', '44100',
    '-f', 'mp3'
  ], ext, 'mp3')
}

function toPTT(buffer, ext) {
  return ffmpeg(buffer, [
    '-vn',
    '-c:a', 'libopus',
    '-b:a', '128k',
    '-vbr', 'on',
    '-compression_level', '10'
  ], ext, 'opus')
}

function toVideo(buffer, ext) {
  return ffmpeg(buffer, [
    '-c:v', 'libx264',
    '-c:a', 'aac',
    '-ab', '128k',
    '-ar', '44100',
    '-crf', '32',
    '-preset', 'slow'
  ], ext, 'mp4')
}


var imgmsg =''
if(config.LANG === 'SI') imgmsg = '*‡∑Ä‡∑ì‡∂©‡∑í‡∂∫‡∑ù‡∑Ä‡∂ö‡∑ä mention ‡∂Ø‡∑ô‡∂±‡∑ä‡∂± !*'
else imgmsg = "*Reply to a video !*"
var descg = ''
if(config.LANG === 'SI') descg = "‡∂ë‡∂∫ ‡∂î‡∂∂‡∂ú‡∑ö mention ‡∂Ø‡∑î‡∂±‡∑ä ‡∑Ä‡∑ì‡∂©‡∑í‡∂∫‡∑ù‡∑Ä audio ‡∂∂‡∑Ä‡∂ß ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í."
else descg = "It converts your replied video to audio [mp3]."
var N_FOUND =''
if(config.LANG === 'SI') N_FOUND = "*‡∂∏‡∂ß ‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑ì‡∂©‡∑í‡∂∫‡∑ù‡∑Ä audio ‡∂∂‡∑Ä‡∂ß ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑Ö ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑í‡∂∫ :(*"
else N_FOUND = "*I cant convert this video to audio :(*"
cmd({
    pattern: "toptt",
    react: "üîä",
    alias: ["toaudio","audio"],
    desc: descg,
    category: "convert",
    use: '.toptt <Reply to video>',
    filename: __filename
},
async(conn, mek, m,{from, l, quoted, body, isCmd, command, args, q, isGroup, sender, senderNumber, botNumber2, botNumber, pushname, isMe, isOwner, groupMetadata, groupName, participants, groupAdmins, isBotAdmins, isAdmins, reply}) => {
try{
    let isquotedvid = m.quoted ? (m.quoted.type === 'videoMessage') : m ? (m.type === 'videoMessage') : false
    if(!isquotedvid) return await reply(imgmsg)
    let media = m.quoted ? await m.quoted.download() : await m.download()
    let auddio = await toPTT(media, 'mp4')
    let senda =  await conn.sendMessage(m.chat, {audio: auddio.options, mimetype:'audio/mpeg'}, {quoted:m})
    await conn.sendMessage(from, { react: { text: 'üéº', key: senda.key }})
} catch (e) {
reply('*Error !!*')
l(e)
}
})





cmd({
    pattern: 'sticker',
    react: 'üí¶',
    alias: ['s', 'stic'],
    desc: descg,
    category: 'convert',
    use: '.sticker <Reply to image>',
    filename: __filename
}, async (conn, mek, m, { from, reply, command, q, pushname }) => {
    try {
        const isQuotedImage = m.quoted && (m.quoted.type === 'imageMessage' || (m.quoted.type === 'viewOnceMessage' && m.quoted.msg.type === 'imageMessage'));
        const isQuotedSticker = m.quoted && m.quoted.type === 'stickerMessage';

        if (m.type === 'imageMessage' || isQuotedImage) {
            const nameJpg = getRandom('.jpg');
            const imageBuffer = isQuotedImage ? await m.quoted.download() : await m.download();
            await fs.writeFile(nameJpg, imageBuffer);

            let sticker = new Sticker(nameJpg, {
                pack: pushname,
                author: '',
                type: q.includes('--crop') || q.includes('-c') ? StickerTypes.CROPPED : StickerTypes.FULL,
                categories: ['ü§©', 'üéâ'],
                id: '12345',
                quality: 75,
                background: 'transparent',
            });

            const buffer = await sticker.toBuffer();
            return conn.sendMessage(from, { sticker: buffer }, { quoted: mek });
        } else if (isQuotedSticker) {
            const nameWebp = getRandom('.webp');
            const stickerBuffer = await m.quoted.download();
            await fs.writeFile(nameWebp, stickerBuffer);

            let sticker = new Sticker(nameWebp, {
                pack: pushname,
                author: 'BLACK LEAUGE MD',
                type: q.includes('--crop') || q.includes('-c') ? StickerTypes.CROPPED : StickerTypes.FULL,
                categories: ['ü§©', 'üéâ'],
                id: '12345',
                quality: 75,
                background: 'transparent',
            });

            const buffer = await sticker.toBuffer();
            return conn.sendMessage(from, { sticker: buffer }, { quoted: mek });
        } else {
            return reply(imgmsg);
        }
    } catch (e) {
        console.error(e);
        return reply('*Error!!*');
    }
});
